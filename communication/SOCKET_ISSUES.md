# Socket通信可能遇到的问题

本文档列出了在使用socket与树莓派机器人服务器通信时可能遇到的问题及解决方案。

## 1. 连接问题

### 网络不可达
**症状**: 连接超时，无法连接到服务器
```
[SocketClient] ✗ Connection failed: [Errno 61] Connection refused
```

**可能原因**:
- 树莓派IP地址错误
- 树莓派未启动或服务未运行
- 网络不通（不在同一网络）

**解决方案**:
- 检查环境变量 `ME578_RPI_IP_ADDR` 是否正确设置
- 使用 `ping <树莓派IP>` 测试网络连通性
- 确认树莓派上的服务器程序正在运行
- 检查防火墙设置

### 端口被占用
**症状**: 连接被拒绝
```
[SocketClient] ✗ Connection failed: [Errno 61] Connection refused
```

**可能原因**:
- 端口5005被其他程序占用
- 服务器未监听该端口

**解决方案**:
- 检查树莓派上端口5005是否被占用: `netstat -tuln | grep 5005`
- 确认服务器程序正确绑定到端口5005
- 检查服务器日志

### 防火墙阻止
**症状**: 连接超时或连接被拒绝

**解决方案**:
- 在树莓派上配置防火墙规则允许端口5005
- 如果使用ufw: `sudo ufw allow 5005`
- 如果使用iptables: 添加相应规则

## 2. 超时问题

### 连接超时
**症状**: 连接建立超时
```
[SocketClient] ✗ Connection timeout (attempt 1/3)
```

**可能原因**:
- 网络延迟高
- 服务器响应慢
- 超时设置过短

**解决方案**:
- 增加 `ROBOT_SOCKET_TIMEOUT` 配置值（默认5秒）
- 检查网络质量
- 确认服务器正常运行

### 接收超时
**症状**: 发送成功但接收响应超时
```
[SocketClient] ✗ Receive timeout (attempt 1/3)
```

**可能原因**:
- 服务器处理时间过长
- 服务器未发送响应
- 网络延迟

**解决方案**:
- 增加超时时间
- 检查服务器是否正常处理请求
- 查看服务器日志

## 3. 数据问题

### JSON格式错误
**症状**: 服务器返回"Invalid JSON format"错误

**可能原因**:
- JSON编码问题
- 特殊字符未正确转义
- 数据类型不匹配

**解决方案**:
- 确保所有字符串使用UTF-8编码
- 检查JSON中是否包含特殊字符
- 验证数据类型（x, y, z应为数字）

### 编码问题
**症状**: 中文或特殊字符显示乱码

**解决方案**:
- 确保使用UTF-8编码: `json_str.encode('utf-8')`
- 服务器端也应使用UTF-8解码

### 数据截断
**症状**: 接收到的JSON不完整

**可能原因**:
- 消息过大，被分片传输
- recv缓冲区大小不足（当前1024字节）

**解决方案**:
- 如果消息较大，实现分片接收逻辑
- 增加recv缓冲区大小
- 实现消息长度前缀协议

## 4. 连接稳定性

### 连接意外断开
**症状**: 连接在使用中断开
```
[SocketClient] ✗ Server closed connection
```

**可能原因**:
- 网络波动
- 服务器重启
- 服务器主动关闭连接

**解决方案**:
- 已实现自动重连机制（最多3次重试）
- 检查网络稳定性
- 确认服务器保持连接打开

### 需要实现自动重连
**当前实现**: 
- 已实现自动重连机制
- 连接断开时自动尝试重连
- 重连失败时返回错误状态

## 5. 并发问题

### 多个函数同时调用
**症状**: 响应混乱或连接错误

**当前实现**:
- 使用全局单例SocketClient，所有函数共享同一连接
- 但未实现线程锁，多线程调用可能有问题

**解决方案**:
- 如果需要在多线程环境中使用，添加线程锁
- 或使用线程安全的队列机制

### 响应匹配
**症状**: 响应与请求不对应

**当前实现**:
- 使用阻塞式通信，确保请求-响应一一对应
- 但如果连接断开重连，可能丢失响应

## 6. 错误处理

### 服务器返回错误
**症状**: 服务器返回 `{"status": "error", "message": "..."}`

**当前实现**:
- 检查响应的 `status` 字段
- 如果为 "error" 或 False，返回错误状态
- 包含服务器错误消息

### 异常捕获
**已捕获的异常**:
- `socket.timeout`: 超时异常
- `socket.error`, `OSError`: 网络错误
- `json.JSONDecodeError`: JSON解析错误
- 其他异常也会被捕获并记录

## 7. 调试建议

### 启用详细日志
当前实现已包含详细的调试输出：
- 连接状态
- 发送的命令
- 接收的响应
- 错误信息

### 测试步骤
1. 首先测试网络连通性: `ping <树莓派IP>`
2. 测试端口是否开放: `telnet <树莓派IP> 5005`
3. 使用示例client.py测试基本通信
4. 逐步测试各个robot函数

### 常见错误码
- `[Errno 61] Connection refused`: 服务器未运行或端口未监听
- `[Errno 51] Network is unreachable`: 网络不可达
- `[Errno 60] Operation timed out`: 连接或接收超时

## 8. 配置检查清单

- [ ] 环境变量 `ME578_RPI_IP_ADDR` 已设置
- [ ] `config.py` 中的 `ROBOT_SOCKET_PORT` 与服务器一致（默认5005）
- [ ] `ROBOT_SOCKET_TIMEOUT` 设置合理（默认5秒）
- [ ] 树莓派服务器程序正在运行
- [ ] 防火墙规则已配置
- [ ] 网络连通性正常

## 9. 性能优化建议

- 保持持久连接（已实现）
- 批量发送命令（如果支持）
- 实现连接池（如果需要多连接）
- 添加心跳机制检测连接状态

